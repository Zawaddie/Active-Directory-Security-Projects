# AD Pentesting Lab Exercises

> Practical exercises (offensive & defensive) for your AWS Active Directory lab.
> Use only in your isolated lab environment. Take AMIs/snapshots before any offensive testing.

---

## Table of contents
1. [Overview & Purpose](#overview--purpose)
2. [Prerequisites](#prerequisites)
3. [Lab preparation & safety checklist](#lab-preparation--safety-checklist)
4. [Environment setup commands (safe)](#environment-setup-commands-safe)
5. [Offensive exercises (enumeration → escalation)](#offensive-exercises-enumeration----escalation)
   - [Host & AD enumeration](#host--ad-enumeration)
   - [Password & Kerberos attacks (Kerberoasting, AS-REP)](#password--kerberos-attacks-kerberoasting-as-rep)
   - [Credential theft & reuse (Pass-the-Hash / Pass-the-Ticket)](#credential-theft--reuse-pass-the-hash--pass-the-ticket)
   - [LLMNR/NBT-NS Poisoning & Relaying](#llmnrnbt-ns-poisoning--relaying)
   - [BloodHound / AD graph mapping (collection + analysis)](#bloodhound--ad-graph-mapping-collection--analysis)
   - [Privilege escalation scenarios & AD abuse (high level)](#privilege-escalation-scenarios--ad-abuse-high-level)
6. [Defensive exercises & monitoring](#defensive-exercises--monitoring)
   - [Enable and collect Windows logging](#enable-and-collect-windows-logging)
   - [Hunt rules and detection ideas](#hunt-rules-and-detection-ideas)
   - [Hardening & remediation steps](#hardening--remediation-steps)
7. [Restore & cleanup](#restore--cleanup)
8. [References & further reading](#references--further-reading)

---

## Overview & Purpose
This document gives you a **structured set of lab exercises** to practice both offensive techniques and defensive detections in an Active Directory environment. Each exercise includes objectives, prerequisites, safe commands to prepare the environment, and high-level steps to perform and defend against the technique. Do **not** perform these attacks outside environments you own or are authorized to test.

---

## Prerequisites
- AWS lab up with: `DC01` (Domain Controller), `WS01` and `WS02` (domain-joined workstations), `KALI01` (attacker). See `README.md`.
- Administrative access to DC or ability to create domain users and groups.
- Tools (install on Kali / Windows as needed): `impacket`, `crackmapexec`, `bloodhound/SharpHound`, `Responder`, `hashcat` (for offline cracking), `PowerView` (PowerShell AD enumeration), `Mimikatz` (use with caution), `Rubeus` (Kerberos), `ldapsearch/ldap3`.
- Snapshots / AMIs of DC and workstations created before tests.

---

## Lab preparation & safety checklist
1. **Create AMIs** for `DC01`, `WS01`, `WS02`. Name them `*-pretest`.
2. Verify network isolation: the lab VPC should not be peered to production.
3. Ensure your Security Groups allow the test traffic only between lab machines.
4. Use low-privilege test accounts for enumeration; escalate only as part of controlled exercises.
5. Keep a log of times and changes you make for reproducibility.

---

## Environment setup commands (safe)
These commands help you prepare accounts, shares and objects for the exercises.

### Create OUs and test users (run on DC01 as Domain Admin)
```powershell
Import-Module ActiveDirectory
New-ADOrganizationalUnit -Name "LabUsers" -Path "DC=lab,DC=local"
# Create a test user
New-ADUser -Name "lab.user" -SamAccountName "lab.user" -AccountPassword (ConvertTo-SecureString "P@ssw0rd!" -AsPlainText -Force) -Enabled $true -Path "OU=LabUsers,DC=lab,DC=local"
# Create an account with SPNs (for Kerberoast practice)
New-ADUser -Name "svc_krb" -SamAccountName "svc_krb" -AccountPassword (ConvertTo-SecureString "SvcPass1!" -AsPlainText -Force) -Enabled $true -Path "OU=LabUsers,DC=lab,DC=local"
Set-ADUser -Identity svc_krb -ServicePrincipalNames @{Add="HTTP/webapp.lab.local"}
```

### Create a test share (on DC01 or file server)
```powershell
New-Item -Path C:\hackme -ItemType Directory -Force
New-SmbShare -Name hackme -Path C:\hackme -FullAccess "LAB\Domain Admins"
# Set relaxed NTFS acl for testing
icacls C:\hackme /grant "LAB\lab.user:(OI)(CI)M"
```

---

## Offensive exercises (enumeration → escalation)
Below are exercises ordered from reconnaissance to higher-impact techniques. Each entry is high-level and intended for an isolated lab.

### Host & AD enumeration (low risk)
**Objective:** Build an inventory of hosts, users, groups, domain controllers, shares, and services.

**Tools / commands** (examples):
- **From Kali (Linux):** `nmap -sS -p 88,135,139,389,445,5985 10.0.2.0/24` (service discovery)
- **Use Impacket’s `smbclient` / `rpcclient`** to list shares.
- **PowerView (on Windows):** `Get-NetUser`, `Get-NetComputer`, `Get-NetGroupMember`, `Get-NetShare`.

**Defensive check:** Ensure controlled auditing of LDAP, authentication, and share access. Monitor unusual DNS/LDAP queries and suspicious user enumeration patterns.

---

### Password & Kerberos attacks (Kerberoasting, AS-REP roasting)
**Objective:** Identify stone-cold targets for offline password cracking (Kerberoast) and accounts that can be abused due to pre-authentication disabled (AS-REP).

**Preparations:** Create service accounts with SPNs (see environment setup). Create at least one user with `Pre-auth` disabled if you want to demonstrate AS-REP.

**High-level steps (lab only):**
- **Kerberoast:** request service tickets for SPN-backed accounts then crack the ticket offline (tools: `GetUserSPNs.py` from Impacket, or `Rubeus`)
- **AS-REP roast:** find accounts with `Do not require Kerberos preauthentication` set and request AS-REP responses to crack offline.

**Defensive check:** Monitor for large numbers of TGS requests, anomalous Rubeus-like behavior, and Windows Event IDs related to Kerberos (e.g., 4768, 4769, 4771).

---

### Credential theft & reuse (Pass-the-Hash / Pass-the-Ticket)
**Objective:** Demonstrate how NTLM hashes or Kerberos tickets can be reused to move laterally.

**High-level steps:**
- Use a credential-dumping tool (lab-only) to extract hashes (e.g., Mimikatz) from a compromised host.
- Use `psexec.py` or `wmiexec.py` (Impacket) or `pth` modules to authenticate to other hosts with the hash.
- For Kerberos, use a stolen TGT/TGS to request service tickets (Pass-the-Ticket).

**Defensive check:** Ensure credential protection (LSA protection, SMB signing), monitor for unusual NTLM usage and lifecycle, enable detection for Lateral Movement indicators.

---

### LLMNR / NBT-NS poisoning & Relaying
**Objective:** Simulate network-based credential capture and relay attacks.

**Tools:** `Responder` to poison LLMNR/NBT-NS; `ntlmrelayx.py` (Impacket) for relaying to SMB/HTTP.

**Defensive check:** Disable LLMNR/NBT-NS via GPO, enable SMB signing, and monitor for SMB authentication failures and suspicious relay-like patterns.

---

### BloodHound / AD graph mapping (collection + analysis)
**Objective:** Map AD relationships and identify privileged paths to domain compromise.

**Steps:**
- Collect data using `SharpHound` or `BloodHound` collectors from a domain-joined host.
- Import data into the BloodHound Neo4j interface and run built-in queries (`Shortest Paths to Domain Admins`, `Find Principals with DCSync` etc.).

**Defensive check:** Harden high-value accounts, monitor for unexpected SharpHound-like collection activity (distinct API calls, LDAP enumeration frequency), and limit LDAP/ACL exposure.

---

### Privilege escalation scenarios & AD abuse (high level)
**Objective:** Explore typical AD abuse techniques such as DCSync, ACL manipulation, unconstrained delegation, and DCShadow.

**High-level notes:**
- **DCSync:** abusing replication rights to pull user password hashes from DCs — protect by restricting `Replicating Directory Changes` rights.
- **Unconstrained delegation:** identify computers/users configured with delegation and test how Kerberos delegation can be abused.
- **DCShadow:** high-risk, powerful capability to inject directory changes; exercise only in isolated lab and snapshot beforehand.

**Defensive check:** Audit privileged ACL changes, monitor for abnormal replication or directory write operations, and limit privileged permissions.

---

## Defensive exercises & monitoring
These exercises focus on turning on logs, collecting telemetry, and hunting for the techniques above.

### Enable and collect Windows logging
**Key logs:**
- **Authentication:** Event IDs 4624 (logon), 4625 (failed logon), 4768/4769 (Kerberos ticketing), 4776 (NTLM auth)
- **Directory Services:** AD audit events (e.g., 5136 for directory changes)
- **Security auditing:** Object access, process creation, privileged group changes

**Configuration tips:**
- Enable `Advanced Audit Policy Configuration` via GPO for detailed Kerberos/Account/Directory auditing.
- Centralise event collection (Wazuh, Splunk, Elastic) — forward Windows Event logs.

### Hunt rules and detection ideas
- Detect spikes in TGS requests for a single SPN (Kerberoasting activity).
- Detect many AS-REP responses requested for accounts with pre-auth disabled.
- Watch for large LDAP enumeration patterns (many `ldapsearch`/SharpHound-like behavior).
- Detect unusual service account login activity or replication-related operations (DCSync).
- Monitor for use of built-in tools (Mimikatz) — look for suspicious LSASS access patterns and process injection.

### Hardening & remediation steps
- Enforce Kerberos pre-auth for all users. Disable legacy protocols.
- Enable SMB signing and disable NTLM where possible.
- Remove unnecessary SPNs or rotate service account passwords regularly.
- Implement least privilege for replication and directory write rights.
- Apply LSA protection and Credential Guard on endpoints where supported.

---

## Restore & cleanup
- If an exercise damages AD state, **restore from AMI** created before testing.
- Remove any test accounts and restore group memberships as required.
- Revert GPO or registry changes made for specific tests.

---

## References & further reading
- BloodHound: https://bloodhound.readthedocs.io/
- Impacket: https://github.com/SecureAuthCorp/impacket
- Rubeus: https://github.com/GhostPack/Rubeus
- Mimikatz: https://github.com/gentilkiwi/mimikatz
- Microsoft security guidance for Active Directory hardening: https://learn.microsoft.com/

---

> **Reminder:** All offensive steps must be performed only in this isolated lab. Keep snapshots and document your tests. If you want, I can convert any exercise above into a step-by-step lab notebook entry with commands and expected outputs — tell me which one and I’ll expand it.

